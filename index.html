<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Webã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            /* ç”»é¢å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«è¨­å®š */
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
        }

        /* ãƒ“ãƒ‡ã‚ªè¦ç´ ã¨ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚’é…ç½®ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
        #main-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’æ­£æ–¹å½¢ã«ã™ã‚‹ */
        #video-container {
            position: relative;
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦ä½¿ã† */
            height: 100%;
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
            overflow: hidden;
        }
        
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.1s ease-out; /* æ»‘ã‚‰ã‹ãªã‚ºãƒ¼ãƒ åŠ¹æœ */
        }

        /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .score-board {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-basis: 100px; /* æ¨ªå¹…ã‚’ç‹­ãå›ºå®š */
            flex-shrink: 0;
            height: 100%;
            background-color: #2d3748;
            padding: 0.5rem;
            text-align: center;
            user-select: none;
        }
        
        /* å¾—ç‚¹è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .score-board h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .score-board p {
            font-size: 6rem;
            font-weight: bold;
            line-height: 1;
        }
        
        /* å¾—ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .score-markers-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 0.25rem 0;
            width: 100%;
            padding: 0 0.25rem;
            box-sizing: border-box;
        }

        /* å¾—ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã®å›²ã„ */
        .score-box {
            width: 100%;
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å›²ã„ã‚’ãã£ã¤ã‘ã‚‹ãŸã‚ã®è§’ä¸¸ã®èª¿æ•´ */
        .score-box:first-child {
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .score-box:last-child {
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }
        .score-box:not(:first-child) {
            border-top-width: 0;
        }

        /* å¾—ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã®â— */
        .score-dot {
            font-size: 4rem; /* ã‚µã‚¤ã‚ºã‚’å°ã•ã */
            font-weight: bold;
            line-height: 1;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆå·¦å´ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #left-score-board h2, #left-score-board p, #left-score-board .score-dot {
            color: #ec4899;
        }
        
        #left-score-board .score-box {
            border-color: #ec4899;
        }
        
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼ˆå³å´ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #right-score-board h2, #right-score-board p, #right-score-board .score-dot {
            color: #38bdf8;
        }
        
        #right-score-board .score-box {
            border-color: #38bdf8;
        }
        
        /* ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å·¦ä¸‹ã¨å³ä¸‹ã«å¤‰æ›´ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« */
        #buttons-container {
            position: absolute;
            bottom: 2rem;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            box-sizing: border-box;
            z-index: 20;
        }
    </style>
</head>
<body class="text-white">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="main-container">

        <!-- å·¦å´ã®ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
        <div id="left-score-board" class="score-board rounded-r-xl">
            <h2>PLAYER 1</h2>
            <div id="score-markers-1" class="score-markers-container">
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
            </div>
            <p id="score-1">0</p>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©ç”»é¢ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <div id="no-camera-message" class="absolute inset-0 flex items-center justify-center text-red-500 font-bold hidden bg-black bg-opacity-75 p-4 text-center">
                ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>

            <!-- ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚«ãƒ¡ãƒ©ç”»é¢å†…ã«ç§»å‹• -->
            <div id="buttons-container">
                <button id="fullscreenButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-2xl transition duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50">
                    ğŸ—–
                </button>
                <button id="undoButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-2xl transition duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50">
                    â†¶
                </button>
                <button id="resetButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-2xl transition duration-300 transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50">
                    â†º
                </button>
            </div>
        </div>

        <!-- å³å´ã®ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
        <div id="right-score-board" class="score-board rounded-l-xl">
            <h2>PLAYER 2</h2>
            <div id="score-markers-2" class="score-markers-container">
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
                <div class="score-box"><span class="score-dot hidden">â—</span></div>
            </div>
            <p id="score-2">0</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const video = document.getElementById('videoElement');
            const noCameraMessage = document.getElementById('no-camera-message');
            const resetButton = document.getElementById('resetButton');
            const undoButton = document.getElementById('undoButton');
            const fullscreenButton = document.getElementById('fullscreenButton');
            const score1 = document.getElementById('score-1');
            const score2 = document.getElementById('score-2');
            const player1Markers = document.querySelectorAll('#score-markers-1 .score-dot');
            const player2Markers = document.querySelectorAll('#score-markers-2 .score-dot');
            let stream = null;
            let scoreHistory = [{ player1: 0, player2: 0 }]; // å¾—ç‚¹ã®å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é…åˆ—

            let player1Score = 0;
            let player2Score = 0;

            let isDragging = false;
            let startX = 0;
            let initialScale = 1;
            let currentScale = 1;

            let initialPinchDistance = 0;

            // ã‚«ãƒ¡ãƒ©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
            const startCamera = async () => {
                try {
                    // ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚
                    const videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment' // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                        }
                    });
                    stream = videoStream;
                    video.srcObject = stream;
                    noCameraMessage.classList.add('hidden');

                    // å‹•ç”»ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã€æ¯”ç‡ã«åˆã‚ã›ã¦ã‚µã‚¤ã‚ºã‚’èª¿æ•´
                    video.onloadedmetadata = () => {
                        adjustVideoSize();
                    };
                    window.addEventListener('resize', adjustVideoSize);

                } catch (error) {
                    console.error("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ", error);
                    noCameraMessage.classList.remove('hidden');
                }
            };
            
            // ãƒ“ãƒ‡ã‚ªã®ã‚µã‚¤ã‚ºã‚’æ­£æ–¹å½¢ã«åˆã‚ã›ã‚‹é–¢æ•°
            const adjustVideoSize = () => {
                const videoContainer = document.getElementById('video-container');
                const size = Math.min(window.innerWidth, window.innerHeight) * 0.8; // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦èª¿æ•´
                videoContainer.style.width = `${size}px`;
                videoContainer.style.height = `${size}px`;
            };

            // ã‚¹ã‚³ã‚¢ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            const updateMarkers = (markers, score) => {
                markers.forEach((marker, index) => {
                    if (index < score) {
                        marker.classList.remove('hidden');
                    } else {
                        marker.classList.add('hidden');
                    }
                });
            };
            
            // ã‚¹ã‚³ã‚¢ã¨UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            const updateUI = () => {
                score1.textContent = player1Score;
                score2.textContent = player2Score;
                updateMarkers(player1Markers, player1Score);
                updateMarkers(player2Markers, player2Score);
            };

            // ã‚ºãƒ¼ãƒ ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
            const applyZoom = (scale) => {
                video.style.transform = `scale(${scale})`;
            };

            // ã‚ºãƒ¼ãƒ æ“ä½œã®é–‹å§‹ï¼ˆã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹å…±é€šï¼‰
            const handleStart = (e) => {
                if (e.touches && e.touches.length === 2) {
                    // ãƒ”ãƒ³ãƒæ“ä½œã®é–‹å§‹
                    isDragging = false;
                    initialPinchDistance = Math.hypot(
                        e.touches[1].pageX - e.touches[0].pageX,
                        e.touches[1].pageY - e.touches[0].pageY
                    );
                    initialScale = currentScale;
                } else if (!e.touches) {
                    // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®é–‹å§‹
                    isDragging = true;
                    startX = e.clientX;
                    initialScale = currentScale;
                }
                e.preventDefault();
            };

            // ã‚ºãƒ¼ãƒ æ“ä½œä¸­ï¼ˆã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹å…±é€šï¼‰
            const handleMove = (e) => {
                if (e.touches && e.touches.length === 2) {
                    // ãƒ”ãƒ³ãƒæ“ä½œ
                    const currentPinchDistance = Math.hypot(
                        e.touches[1].pageX - e.touches[0].pageX,
                        e.touches[1].pageY - e.touches[0].pageY
                    );
                    let newScale = initialScale * (currentPinchDistance / initialPinchDistance);
                    
                    // ã‚ºãƒ¼ãƒ ã®æœ€å¤§ãƒ»æœ€å°å€¤ã‚’è¨­å®š
                    newScale = Math.max(1, Math.min(newScale, 3));
                    applyZoom(newScale);
                    currentScale = newScale;
                } else if (isDragging) {
                    // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
                    const currentX = e.clientX;
                    const deltaX = currentX - startX;
                    const sensitivity = 0.005; // ã‚ºãƒ¼ãƒ ã®æ„Ÿåº¦ã‚’èª¿æ•´
                    
                    let newScale = initialScale + deltaX * sensitivity;
                    
                    // ã‚ºãƒ¼ãƒ ã®æœ€å¤§ãƒ»æœ€å°å€¤ã‚’è¨­å®š
                    newScale = Math.max(1, Math.min(newScale, 3));
                    applyZoom(newScale);
                    currentScale = newScale;
                }
            };

            // ã‚ºãƒ¼ãƒ æ“ä½œã®çµ‚äº†ï¼ˆã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹å…±é€šï¼‰
            const handleEnd = () => {
                isDragging = false;
            };

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’çµ±åˆ
            video.addEventListener('mousedown', handleStart);
            video.addEventListener('touchstart', handleStart);
            video.addEventListener('mousemove', handleMove);
            video.addEventListener('touchmove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            window.addEventListener('touchend', handleEnd);
            window.addEventListener('mouseleave', handleEnd);

            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            fullscreenButton.addEventListener('click', () => {
                document.body.requestFullscreen();
            });

            // Undoãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            undoButton.addEventListener('click', () => {
                if (scoreHistory.length > 1) { // æœ€åˆã®çŠ¶æ…‹ (0,0) ã¯ä¿æŒ
                    scoreHistory.pop(); // æœ€æ–°ã®å±¥æ­´ã‚’å‰Šé™¤
                    const previousState = scoreHistory[scoreHistory.length - 1];
                    player1Score = previousState.player1;
                    player2Score = previousState.player2;
                    updateUI();
                }
            });

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            resetButton.addEventListener('click', () => {
                player1Score = 0;
                player2Score = 0;
                scoreHistory = [{ player1: 0, player2: 0 }];
                updateUI();
            });
            
            // ã‚¹ã‚³ã‚¢ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('left-score-board').addEventListener('click', () => {
                player1Score++;
                scoreHistory.push({ player1: player1Score, player2: player2Score });
                updateUI();
            });

            document.getElementById('right-score-board').addEventListener('click', () => {
                player2Score++;
                scoreHistory.push({ player1: player1Score, player2: player2Score });
                updateUI();
            });

            // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            startCamera();
        });
    </script>
</body>
</html>

